<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Magical Birthday Cake ‚Äî Tanu üéÇ</title>
<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#fff7fb;
    --bg2:#eef9ff;
    --accent:#ff6ec4;
    --accent2:#a485ff;
    --choc1:#5b3725;
    --choc2:#7a5139;
    --shadow:0 18px 50px rgba(0,0,0,0.12);
    --table:#f6e7dd;
    --table-leg:#d9bfae;
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;
    height:100%;
    font-family:"Poppins",system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    color:#352033;
    -webkit-font-smoothing:antialiased;
  }
  body{overflow-x:hidden;padding-bottom:120px;}

  header{
    text-align:center;
    padding:22px 16px 8px;
  }
  header h1{
    font-family:"Pacifico",cursive;
    font-size:36px;
    margin:0;
    color:var(--accent);
    text-shadow:0 4px 12px rgba(255,160,200,0.2);
  }
  header p{
    margin:8px auto 0;
    max-width:860px;
    color:#6b4a56;
  }

  /* layout */
  .layout{
    max-width:1200px;
    margin:0 auto;
    padding:18px;
    display:flex;
    gap:24px;
    align-items:flex-start;
    justify-content:space-between;
  }
  .left{
    flex:0 0 72%;
    display:flex;
    flex-direction:column;
    gap:18px;
    align-items:center;
  }
  .right{
    flex:0 0 28%;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  /* table card */
  .table-card{
  width:100%;
  max-width:900px;
  background:linear-gradient(180deg,#fff,var(--table));
  border-radius:18px;
  box-shadow:var(--shadow);
  padding:18px 32px 32px; /* reduced padding */
  position:relative;
}
.table-card::after{
  content:"";
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:150px; /* ‚¨Ö this keeps tabletop INSIDE the box and under the cake */
  width:70%;
  height:22px;
  border-radius:12px;
  background:linear-gradient(180deg,#d9bfae,#cfaea0);
  box-shadow:0 6px 12px rgba(0,0,0,0.12);
  z-index:1;
}

  .table-legs{
    margin-top:18px;
    display:flex;
    justify-content:center;
    gap:120px;
  }
  .leg{
    width:14px;
    height:70px;
    border-radius:6px;
    background:var(--table-leg);
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
  }

  /* scene */
  .scene{
  display:flex;
  align-items:center;
  justify-content:center;   /* fully center aligned */
  gap:0;                    /* remove unnecessary spacing */
  min-height:260px;
}

  /* CAKE SCENE */
  .cake-scene{
    flex:1;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .cake-wrap{
    width:520px;
    max-width:100%;
    position:relative;
    display:flex;
    flex-direction:column;
    align-items:center;
  }

  .plate{
    width:78%;
    height:32px;
    background:linear-gradient(180deg,#fff,#f2f2f2);
    border-radius:20px;
    position:absolute;
    bottom:-52px;
    box-shadow:0 10px 26px rgba(0,0,0,0.12);
  }

  .cake-body{
    width:420px;
    height:170px;
    background:linear-gradient(180deg,var(--choc1),var(--choc2));
    bottom:-52px;
    border-radius:22px;
    position:relative;
    box-shadow:0 14px 40px rgba(0,0,0,0.18);
  }
  .cake-frost{
    position:absolute;
    left:8%;
    right:8%;
    height:36px;
    top:-18px;
    border-radius:18px;
    background:linear-gradient(180deg,#ffe8dc,#ffd6c7);
    box-shadow:inset 0 6px 12px rgba(255,255,255,0.12);
  }
  .cake-crumb{
    position:absolute;
    inset:12% 10% 10%;
    border-radius:14px;
    background:linear-gradient(180deg,#5b3725,#7a5139);
  }

  /* slice */
  .slice{
    position:absolute;
    right:9%;
    bottom:-26px;
    width:115px;
    height:90px;
    border-radius:18px 18px 12px 12px;
    background:linear-gradient(180deg,#8b5a46,#a06b4e);
    box-shadow:0 12px 30px rgba(0,0,0,0.18);
    overflow:hidden;
    opacity:0;
    transform:translate(0,0) rotate(0deg) scale(.9);
    pointer-events:none;
  }
  .slice-frost{
    position:absolute;
    left:10%;
    right:10%;
    top:-8px;
    height:22px;
    border-radius:14px;
    background:linear-gradient(180deg,#ffe8dc,#ffd6c7);
  }
  .slice-crumb{
    position:absolute;
    inset:18% 12% 8%;
    border-radius:12px;
    background:linear-gradient(180deg,#5b3725,#7a5139);
  }

  /* candle */
  .candle{
    position:absolute;
    left:50%;
    top:-46px;
    transform:translateX(-50%);
    width:16px;
    height:46px;
    border-radius:8px;
    background:linear-gradient(180deg,#fff9c9,#ffd6a6);
    box-shadow:inset 0 -4px 6px rgba(0,0,0,0.06),0 6px 18px rgba(0,0,0,0.12);
    cursor:pointer;
  }
  .flame{
    position:absolute;
    top:-24px;
    left:50%;
    transform:translateX(-50%);
    width:16px;
    height:22px;
    border-radius:50% 50% 40% 40%;
    background:radial-gradient(circle,#fff 0%,#ffeb3b 40%,#ff9800 70%,#ff5722 100%);
    box-shadow:0 0 10px rgba(255,200,60,0.95);
    animation:flicker .4s infinite alternate;
  }
  @keyframes flicker{
    0%{transform:translateX(-50%) scale(1);}
    100%{transform:translateX(-50%) scale(1.14);opacity:.9;}
  }
  .smoke{
    position:absolute;
    left:50%;
    top:-18px;
    width:8px;
    height:0;
    transform:translateX(-50%);
    border-radius:50px;
    background:rgba(200,200,200,0.5);
    opacity:0;
  }
  .candle.blown .flame{opacity:0;animation:none;}
  .candle.blown .smoke{
    opacity:.9;
    animation:smokeUp 1.1s forwards;
  }
  @keyframes smokeUp{
    0%{height:0;transform:translateX(-50%) translateY(0);opacity:.8;}
    100%{height:42px;transform:translateX(-50%) translateY(-40px);opacity:0;}
  }

  /* knife */
  .knife{
    position:absolute;
    left:40px;
    top:90px;
    width:210px;
    height:40px;
    display:flex;
    align-items:center;
    gap:10px;
    transform:rotate(-16deg);
    cursor:grab;
  }
 .knife-handle{
  width:80px;
  height:32px;
  background:linear-gradient(90deg,#ff2d2d,#cc0000); /* RED handle */
  border-radius:8px;
  box-shadow:inset 0 -3px 6px rgba(0,0,0,0.25);
}

  .knife-blade{
    width:130px;
    height:14px;
    background:linear-gradient(90deg,#f5f7fb,#cbd3df);
    border-radius:4px;
    box-shadow:0 6px 16px rgba(0,0,0,0.16);
  }

  .controls{
    margin-top:18px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:center;
  }
  .btn{
    padding:9px 16px;
    border-radius:999px;
    border:none;
    font-weight:600;
    cursor:pointer;
    background:linear-gradient(90deg,var(--accent2),var(--accent));
    color:#fff;
    box-shadow:0 10px 26px rgba(117,198,255,0.12);
  }
  .btn.white{
    background:#fff;
    color:#352033;
    border:1px solid rgba(0,0,0,0.06);
    box-shadow:none;
  }

  /* right gift card */
  .gift-card{
    width:100%;
    max-width:260px;
    padding:18px;
    border-radius:14px;
    background:#fff;
    box-shadow:var(--shadow);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
  }
  .gift-top{
    width:100%;
    height:150px;
    border-radius:14px;
    background:linear-gradient(180deg,#ffb6d4,#ff6ec4);
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
    cursor:pointer;
  }
  .gift-top::before{
    content:"";
    position:absolute;
    left:50%;
    top:50%;
    width:120%;
    height:18px;
    transform:translate(-50%,-50%);
    border-radius:12px;
    background:rgba(255,255,255,0.45);
  }
  .gift-name{
    position:absolute;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    padding:4px 16px;
    border-radius:999px;
    background:#fff;
    color:#ff4e91;
    font-weight:600;
    box-shadow:0 8px 20px rgba(0,0,0,0.16);
  }

  .gift-icon{
    font-size:38px;
    z-index:1;
  }

  .gift-card p{
    margin:0;
    color:#52334a;
    font-size:14px;
  }
.sparkle{
  position:fixed;
  top:-20px;
  width:8px;
  height:8px;
  border-radius:50%;
  background:radial-gradient(circle,#fff,#ffe8c2,#ffb6c9);
  z-index:99999;
  opacity:0.9;
  pointer-events:none;
}
  /* balloons */
  .balloon{
    width:52px;
    height:68px;
    border-radius:50%;
    position:fixed;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:20px;
    color:#fff;
    box-shadow:0 18px 40px rgba(0,0,0,0.12);
    z-index:60;
  }
  .b1{left:6%;top:28%;background:linear-gradient(180deg,#ff6ec4,#ff9acb);}
  .b2{left:13%;top:12%;background:linear-gradient(180deg,#ffd166,#ffb347);}
  .b3{left:20%;top:42%;background:linear-gradient(180deg,#75c6ff,#4da6ff);}
  .b4{right:11%;top:18%;background:linear-gradient(180deg,#c175ff,#a485ff);}
  .b5{right:6%;top:36%;background:linear-gradient(180deg,#ff4e91,#ff6ec4);}
  .b6{left:8%; top:55%; background:linear-gradient(180deg,#ff8abe,#ff6ec4);}
  .b7{left:3%; top:70%; background:linear-gradient(180deg,#7edcff,#4da6ff);}
  .b8{right:4%; top:55%; background:linear-gradient(180deg,#ffaf5f,#ff7b39);}
  .b9{right:12%; top:70%; background:linear-gradient(180deg,#c175ff,#8f5aff);}
  .b10{left:19%; top:5%; background:linear-gradient(180deg,#ff4e91,#ff2e78);}


  .confetti{
    position:fixed;
    width:9px;
    height:12px;
    border-radius:2px;
    z-index:10000;
  }

.popup{
  position:fixed;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%) scale(.6);
  background:linear-gradient(180deg,#fff,#fff0fa);
  border-radius:18px;
  padding:26px 30px;
  box-shadow:0 20px 60px rgba(0,0,0,0.28);
  opacity:0;
  pointer-events:none;
  transition:all .35s cubic-bezier(.2,1.2,.4,1);
  z-index: 99999999;
  max-width:380px;
}

.popup.show{
  opacity:1;
  transform:translate(-50%,-50%) scale(1);
}

.popup h3{
  margin:0 0 10px;
  font-size:22px;
  color:#ff4e91;
}

.popup p{
  font-size:16px;
  line-height:1.5;
  color:#5b3650;
}
.gift-top.open{
  animation:openGift .5s ease forwards;
}

@keyframes openGift{
  0%{transform:rotateX(0deg);}
  100%{transform:rotateX(70deg);}
}

  .bottom-nav{
    position:fixed;
    left:50%;
    transform:translateX(-50%);
    bottom:18px;
    display:flex;
    gap:10px;
  }

  @media(max-width:960px){
    .layout{flex-direction:column;align-items:center;}
    .left,.right{flex:0 0 100%;max-width:100%;}
  }
  @media(max-width:520px){
    header h1{font-size:30px;}
    .balloon{display:none;}
    .table-card{padding:22px 16px 30px;}
    .cake-wrap{width:100%;}
    .cake-body{width:320px;}
  }
</style>
</head>
<body>

<audio id="bgAudio" loop preload="auto">
  <source src="bday.mp3" type="audio/mpeg">
</audio>

<header>
  <h1>Make a Wish, Tanu üéÇ</h1>
  <p>Close your eyes ‚Äî wish big. Everything on this table is made with love for you.</p>
</header>

<main class="layout" role="main">
  <!-- LEFT: cake area -->
  <section class="left" aria-label="Cake area">
    <div class="table-card">
      <div class="scene">
        <div class="cake-scene">
          <div class="cake-wrap" id="cakeWrap">
            <div class="plate"></div>

            <div class="cake-body" id="cakeBody">
              <div class="cake-frost"></div>
              <div class="cake-crumb"></div>

              <div class="candle" id="candle" tabindex="0">
                <div class="flame"></div>
                <div class="smoke"></div>
              </div>
            </div>

            <div class="slice" id="slice">
              <div class="slice-frost"></div>
              <div class="slice-crumb"></div>
            </div>

            <div class="knife" id="knife" tabindex="0">
              <div class="knife-handle"></div>
              <div class="knife-blade"></div>
            </div>
          </div>
        </div>

        <!-- little decorative card on right side of table -->
        <div style="flex-shrink:0;">
          <div style="width:110px;height:110px;border-radius:14px;background:linear-gradient(180deg,#fff8f9,#ffeef5);box-shadow:0 10px 26px rgba(0,0,0,0.08);display:flex;align-items:center;justify-content:center;font-size:26px;">
            ‚ú®
          </div>
        </div>
      </div>

      <div class="table-legs" aria-hidden="true">
        <div class="leg"></div><div class="leg"></div>
      </div>

      <div class="controls">
        <button class="btn" id="enableBlow">Tap to enable blow</button>
        <button class="btn white" id="cutBtn">Cut Cake</button>
        <button class="btn white" id="extBtn">Click Candle to Extinguish</button>
      </div>
    </div>
  </section>

  <!-- RIGHT: gift area -->
  <aside class="right" aria-label="Gift area">
    <div class="gift-card">
      <div class="gift-top" id="gift">
        <div class="gift-name">Tanu</div>
        <div class="gift-icon">üéÅ</div>
      </div>
      <div style="text-align:center;">
        <strong>Surprise Gift</strong>
        <p>Click to open ‚Äî there is a special message for Tanu inside.</p>
      </div>
    </div>
  </aside>
</main>

<!-- balloons -->
<div class="balloon b1">üéà</div>
<div class="balloon b2">üéà</div>
<div class="balloon b3">üéà</div>
<div class="balloon b4">üéà</div>
<div class="balloon b5">üéà</div>
<div class="balloon b6">üéà</div>
<div class="balloon b7">üéà</div>
<div class="balloon b8">üéà</div>
<div class="balloon b9">üéà</div>
<div class="balloon b10">üéà</div>

<div id="confettiRoot" style="position:fixed;inset:0;pointer-events:none;z-index:9999"></div>

<div class="popup" id="popup">
  <h3 id="popupTitle">Happy Birthday, Tanu! üíñ</h3>
  <p id="popupText">You are the best ‚Äî love you! Make a wish and enjoy your day.</p>
  <button class="btn white" id="closePopup">Close</button>
</div>

<div class="bottom-nav">
  <a href="index.html" class="btn white">‚Üê Back to starting page</a>
  <button class="btn" id="backMemory">Back to Memories</button>
  <button class="btn" id="nextBtn">Next Surprise ‚Üí Letter</button>
</div>

<script>
/* ---------------------------------------
   GLOBAL STATE
---------------------------------------- */
window.__suppressPopups = false;

let micStream = null;
let audioCtx = null;
let analyser = null;
let raf = null;

/* ---------------------------------------
   POPUP (FINAL FIXED VERSION)
---------------------------------------- */
(function(){

const pop = document.getElementById("popup");
const closeBtn = document.getElementById("closePopup");

function hidePopup(){
    pop.classList.remove("show");
    pop.style.pointerEvents = "none";
}

window.showPopup = function(msg){
    if(window.__suppressPopups) return;

    document.getElementById("popupText").textContent = msg;
    pop.classList.add("show");
    pop.style.pointerEvents = "auto";  // allow interaction
};

// close button WORKING
closeBtn.addEventListener("click", hidePopup);

// clicking OUTSIDE the popup content closes it
pop.addEventListener("mousedown", (e)=>{
    if(e.target === pop) hidePopup();
});

})();


/* ---------- bg music with simple resume ---------- */
(function(){
  const audio = document.getElementById('bgAudio');
  try{
    const t = parseFloat(localStorage.getItem('bgAudioTime') || '0');
    if(!isNaN(t) && t>0) audio.currentTime = t;
  }catch(e){}
  audio.muted = true;
  const p = audio.play();
  if(p && p.then) p.then(()=>{audio.pause();audio.muted=false;}).catch(()=>{});

  function start(){
    audio.muted = false;
    audio.play().catch(()=>{});
    document.removeEventListener('pointerdown',start);
    document.removeEventListener('keydown',start);
  }
  document.addEventListener('pointerdown',start,{once:true});
  document.addEventListener('keydown',start,{once:true});

  window.addEventListener('beforeunload',()=>{
    try{localStorage.setItem('bgAudioTime',String(audio.currentTime||0));}catch(e){}
  });
})();

/* ---------- balloons float + pop ---------- */
(function(){
  const balloons = Array.from(document.querySelectorAll('.balloon'));
  balloons.forEach(b => {
    const phase = Math.random()*Math.PI*2;
    const amp = 12 + Math.random()*10;
    const rotAmp = 8 + Math.random()*6;
    (function anim(){
      const t = Date.now()/1200 + phase;
      const x = Math.cos(t/1.6)*amp;
      const y = Math.sin(t)*10;
      const rot = Math.sin(t/2)*rotAmp;
      b.style.transform = `translate(${x}px,${y}px) rotate(${rot}deg)`;
      requestAnimationFrame(anim);
    })();

    function pop(){
      if(b.classList.contains('gone')) return;
      b.classList.add('gone');
      const r = b.getBoundingClientRect();
      burstConfetti(r.left+r.width/2,r.top+r.height/2,20);
      b.style.transition='all .35s ease';
      b.style.transform+=' scale(0)';
      b.style.opacity='0';
      setTimeout(()=>b.remove(),360);
    }
    b.addEventListener('click',pop);
    b.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();pop();}});
  });
})();

/* ---------- confetti helper ---------- */
function burstConfetti(x,y,count){
  const root = document.getElementById('confettiRoot');
  const colors = ['#ff6ec4','#ffa34d','#ffd166','#75c6ff','#c175ff','#ff4e91','#fff'];
  for(let i=0;i<(count||40);i++){
    const el = document.createElement('div');
    el.className='confetti';
    el.style.left = x+'px';
    el.style.top = y+'px';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.width = (6+Math.random()*8)+'px';
    el.style.height = (4+Math.random()*10)+'px';
    root.appendChild(el);
    const dx = (Math.random()-0.5)*600;
    const dy = (Math.random()*650)+80;
    const rot = Math.random()*720;
    el.animate([
      {transform:'translate3d(0,0,0) rotate(0deg)',opacity:1},
      {transform:`translate3d(${dx}px,${dy}px,0) rotate(${rot}deg)`,opacity:0}
    ],{duration:900+Math.random()*900,easing:'cubic-bezier(.2,.8,.2,1)'});
    setTimeout(()=>el.remove(),2100);
  }
}

/* --------- sparkle (rain) -------*/
function sparkleRain(){
  let duration = 4000; // 4 sec
  let endTime = Date.now() + duration;

  (function drop(){
    if(Date.now() > endTime) return;

    for(let i=0;i<8;i++){
      const s = document.createElement('div');
      s.className = 'sparkle';

      s.style.left = (Math.random() * window.innerWidth) + 'px';
      s.style.opacity = 0.8 + Math.random()*0.3;
      s.style.transform = `scale(${0.7 + Math.random()})`;

      document.body.appendChild(s);

      let fall = s.animate([
        { transform:`translateY(0px)`, opacity:1 },
        { transform:`translateY(${window.innerHeight}px)`, opacity:0 }
      ],{
        duration: 1500 + Math.random()*900,
        easing:'ease-out'
      });

      fall.onfinish = ()=> s.remove();
    }

    requestAnimationFrame(drop);
  })();
}

/* ---------- knife + cut animation ---------- */
(function(){
  const knife = document.getElementById('knife');
  const cakeWrap = document.getElementById('cakeWrap');
  const cutBtn = document.getElementById('cutBtn');
  const slice = document.getElementById('slice');
  let dragging=false, offX=0, offY=0, cut=false;

  knife.addEventListener('pointerdown',e=>{
    dragging=true;
    knife.setPointerCapture(e.pointerId);
    const r = knife.getBoundingClientRect();
    offX = e.clientX - r.left;
    offY = e.clientY - r.top;
    document.addEventListener('pointermove',move);
    document.addEventListener('pointerup',up);
  });

  function move(e){
    if(!dragging) return;
    knife.style.position='fixed';
    knife.style.left=(e.clientX-offX)+'px';
    knife.style.top=(e.clientY-offY)+'px';
    knife.style.zIndex=9999;
  }

  function up(e){
    dragging=false;
    try{knife.releasePointerCapture(e.pointerId);}catch(_){}
    document.removeEventListener('pointermove',move);
    document.removeEventListener('pointerup',up);

    // check over cake
    const cakeRect = cakeWrap.getBoundingClientRect();
    const kRect = knife.getBoundingClientRect();
    const kCenterX = kRect.left + kRect.width/2;
    const kCenterY = kRect.top + kRect.height/2;
    const over = (
      kCenterX > cakeRect.left+40 &&
      kCenterX < cakeRect.right-40 &&
      kCenterY > cakeRect.top &&
      kCenterY < cakeRect.bottom+40
    );

    // reset knife to original
    setTimeout(()=>{
      knife.style.position='absolute';
      knife.style.left='40px';
      knife.style.top='90px';
      knife.style.zIndex='';
    },220);

    if(over) doCut();
  }

  knife.addEventListener('keydown',e=>{
    if(e.key===' '||e.key==='Enter'){e.preventDefault();doCut();}
  });
  cutBtn.addEventListener('click',doCut);

  function doCut(){
    if(cut) return;
    cut=true;

    cakeWrap.animate([
      {transform:'translateY(0)'},
      {transform:'translateY(-6px)'},
      {transform:'translateY(3px)'},
      {transform:'translateY(0)'}
    ],{duration:600,easing:'ease-out'});

    slice.style.opacity='1';
    slice.animate([
      {transform:'translate(-6px,0) rotate(0deg) scale(.9)',opacity:0},
      {transform:'translate(16px,-10px) rotate(-8deg) scale(1)',opacity:1}
    ],{duration:650,easing:'cubic-bezier(.2,.8,.2,1)',fill:'forwards'});

    const r = cakeWrap.getBoundingClientRect();
    burstConfetti(r.left+r.width/2,r.top+40,55);

    // only show popup if popups are allowed
    if(!window.__suppressPopups) showPopup('Cake cut! Make another wish, Tanu üéâ');
    sparkleRain();
  }
})();

/* ---------- candle click + blow (5 candles) ---------- */
(function(){
  const candles = document.querySelectorAll('.candle'); // all candles
  const enable = document.getElementById('enableBlow');
  const extBtn = document.getElementById('extBtn');
  let detect=false;

  /* Click / Keyboard toggle for each candle */
  function toggle(c){
    c.classList.toggle('blown');
  }

  candles.forEach(c=>{
    c.addEventListener('click',()=>toggle(c));
    c.addEventListener('keydown',e=>{
      if(e.key==='Enter'||e.key===' '){
        e.preventDefault();
        toggle(c);
      }
    });
  });

  /* Extinguish by button - guarded */
  extBtn.addEventListener('click',()=>{
    candles.forEach(c => c.classList.add('blown'));
    if(!window.__suppressPopups) showPopup('Candle extinguished ‚Äî make another wish! üïØÔ∏è‚ú®');
  });

  /* Microphone blow detection */
  enable.addEventListener('click',async()=>{
    if(detect){
      stop();
      enable.textContent='Tap to enable blow';
      return;
    }
    try{
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      micStream = stream;

      audioCtx = new (window.AudioContext||window.webkitAudioContext)();
      const src = audioCtx.createMediaStreamSource(stream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      src.connect(analyser);

      const data = new Uint8Array(analyser.fftSize);
      detect = true;
      enable.textContent = 'Stop blow';

      (function loop(){
        if(!detect) return;
        analyser.getByteTimeDomainData(data);
        let sum=0;
        for(let i=0;i<data.length;i++){
          const v=(data[i]-128)/128;
          sum+=v*v;
        }
        const rms=Math.sqrt(sum/data.length);

        if(rms > 0.14){
          // Blow ALL candles
          candles.forEach(c => c.classList.add('blown'));

          if(!window.__suppressPopups) showPopup('You blew the candles! Make a wish, Tanu üíñ');
          stop();
          enable.textContent='Tap to enable blow';
        } else {
          raf = requestAnimationFrame(loop);
        }
      })();

    }catch(e){
      console.error(e);
      if(!window.__suppressPopups) showPopup('Microphone blocked ‚Äî tap the candle to turn it off.');
    }
  });

  /* Stop mic + cleanup */
  function stop(){
    detect=false;
    if(raf) cancelAnimationFrame(raf);
    try{ analyser && analyser.disconnect(); }catch(_){}
    try{ audioCtx && audioCtx.close(); }catch(_){}
    try{ micStream && micStream.getTracks().forEach(t=>t.stop()); }catch(_){}
    analyser=null;audioCtx=null;micStream=null;raf=null;
  }

  // beforeunload: quietly stop mic (no popups)
  window.addEventListener('beforeunload',()=>{
    try{ micStream && micStream.getTracks().forEach(t=>t.stop()); }catch(_){}
  });

  // expose stop for use by other modules if needed
  window._quietStopMic = stop;
})();

/* ---------- gift ---------- */
(function(){
  const gift = document.getElementById('gift');
  const nextBtn = document.getElementById('nextBtn');

  function openGift(){
    gift.classList.toggle('open');
    const r = gift.getBoundingClientRect();
    burstConfetti(r.left+r.width/2,r.top+r.height/2,40);
    if(!window.__suppressPopups) showPopup(
      "Happy Birthday Tanu üéâüíó\nYou are my precious friend ‚Äî truly special. " +
      "Your dream of becoming an Income Tax Officer will come true one day. " +
      "Keep believing in yourself ‚Äî your journey is just beginning!"
    );
  }

  if(gift){
    gift.addEventListener('click',openGift);
    gift.addEventListener('keydown',e=>{
      if(e.key==='Enter'||e.key===' '){e.preventDefault();openGift();}
    });
  }

  if(nextBtn){
    nextBtn.addEventListener('click',()=>{
      // prevent any popups while leaving
      window.__suppressPopups = true;

      // try to stop microphone and any audio context quietly (if present)
      try{ window._quietStopMic && window._quietStopMic(); }catch(_){}

      // remove or disable the extinguish button listener so it can't fire
      try{
        const ext = document.getElementById('extBtn');
        ext && ext.replaceWith(ext.cloneNode(true)); // quick remove listeners
      }catch(_){}

      // navigate after tiny delay to ensure suppression is set
      setTimeout(()=> window.location.href='letter.html', 50);
    });
  }
})();

/* ---------- back to memories ---------- */
(function(){
  const back = document.getElementById('backMemory');
  if(back) back.addEventListener('click',()=>{
    window.__suppressPopups = true;
    try{ window._quietStopMic && window._quietStopMic(); }catch(_){}
    setTimeout(()=> window.location.href='memorylane.html', 50);
  });
})();
</script>
</body>
</html>
